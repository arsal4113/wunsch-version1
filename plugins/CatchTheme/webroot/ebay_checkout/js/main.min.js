var objectToFormData=function(e,t,s){var n,o=t||new FormData;for(var i in e)e.hasOwnProperty(i)&&(n=s?s+"["+i+"]":i,"object"!=typeof e[i]||e[i]instanceof File?o.append(n,e[i]):objectToFormData(e[i],o,n));return o};$.widget("iways.checkout",{options:{errorContainer:".error-message-row",totals:".totals-widget",payment:".payment-widget",item_wrapper:".item-widget-wrapper",shipping_address:".shipping-address-widget",apply_coupon:".apply-coupon-widget",progress_wrapper:".progress-widget",totalsInfo:""},loader:'<div class="loader"><div class="animated-loader"><span>Loading...</span></div></div>',scrollDisabled:!1,_create:function(){this.errorContainer=this.element.find(this.options.errorContainer)},getPayment:function(){return $(this.options.payment)},getTotals:function(){return $(this.options.totals)},getItemWrapper:function(){return $(this.options.item_wrapper)},getShippingAddress:function(){return $(this.options.shipping_address)},getProgressWrapper:function(){return $(this.options.progress_wrapper)},getApplyCoupon:function(){return $(this.options.apply_coupon)},startLoading:function(){$(".content-area").find(".loader").length||($(".content-area").prepend(this.loader),this.element.addClass("loading"))},stopLoading:function(){this.element.removeClass("loading"),$(".loading").length||$(".content-area").find(".loader").remove()},showError:function(e){if(this.removeError(),"string"==$.type(e))this.errorContainer.show().html($('<div class="row"><div class="col error-message">'+e+"</div></div>"));else{var t=this;t.errorContainer.show(),$.each(e,function(e,s){t.errorContainer.append($('<div class="row"><div class="col error-message">'+s+"</div></div>"))})}push2dataLayer({event:"addressError",errorMessage:e})},removeError:function(){this.errorContainer.find(".error-message").remove()},setTotalsInfo:function(){this.getTotals().totals("setText",this.options.totalsInfo)},renderRoverPixel:function(e){this.element.prepend($('<img src="'+e+'" style="display: none;" />'))},scrollTo:function(e,t){if(!this.scrollDisabled){t=void 0!==t?t:350;var s=$(window).width()<1024?$(".progress-widget").height():0;$([document.documentElement,document.body]).animate({scrollTop:$(e).offset().top-$("#header").height()-20-s},t)}},disableScroll:function(){this.scrollDisabled=!0},enableScroll:function(){this.scrollDisabled=!1},getElement:function(){return this.element}}),$.widget("iways.item_wrapper",$.iways.checkout,{options:{getUrl:""},_create:function(){this._super()},refresh:function(){var e=this;e.startLoading(),$.ajax(this.options.getUrl).done(function(t){e.element.parent().html(t),e.stopLoading()})}}),$.widget("iways.item",$.iways.checkout,{options:{saveQtyUrl:"",saveShippingUrl:"",itemId:""},_create:function(){this._super();var e=this;this.element.find("select[name=qty]").change(function(t){e.updateQty($(t.target),$(t.target).val())}),this.element.find(".shipping-options-wrapper input[type=radio]").click(function(t){e.updateShipping($(t.target),$(t.target).val())})},updateQty:function(e,t){var s=this;this.getTotals().totals("startLoading"),s.startLoadingOnAllItems();var n=new FormData;$(e).attr("disabled","disabled"),n.append("itemId",s.options.itemId),n.append("qty",t),$.ajax(this.options.saveQtyUrl,{method:"POST",data:n,processData:!1,contentType:!1,success:function(t){if(t.error)return s.showError(t.error),$(e).removeAttr("disabled"),void s.stopLoadingOnAllItems();s.removeError(),$(e).removeAttr("disabled"),s.checkPayment(),s.getTotals().totals("refresh"),s.refreshAllItems()},error:function(t){s.showError(t.statusText),$(e).removeAttr("disabled"),s.stopLoadingOnAllItems()}})},updateShipping:function(e,t){var s=this;s.getTotals().totals("setCheckbox",$("#marketing_consent").is(":checked"),$("#catch-marketing_consent").is(":checked")),this.getTotals().totals("startLoading"),s.startLoadingOnAllItems();var n=new FormData;n.append("itemId",s.options.itemId),n.append("shippingId",t),$.ajax(this.options.saveShippingUrl,{method:"POST",data:n,contentType:!1,processData:!1,success:function(e){if(e.error)return s.showError(e.error),void s.stopLoadingOnAllItems();s.removeError(),s.checkPayment(),s.getTotals().totals("refresh"),s.refreshAllItems(),s.checkPayment()},error:function(e){s.showError(e.statusText),s.stopLoadingOnAllItems()}})},refreshAllItems:function(){$(".item-widget-wrapper").item_wrapper("refresh")},startLoadingOnAllItems:function(){$(".item-widget-wrapper").item_wrapper("startLoading")},stopLoadingOnAllItems:function(){$(".item-widget-wrapper").item_wrapper("stopLoading")},checkPayment:function(){this.getShippingAddress().shipping_address("getElement").hasClass("address-entered")?this.getPayment().payment("enable"):this.getShippingAddress().shipping_address("enable")}}),$.widget("iways.shipping_address",$.iways.checkout,{options:{getUrl:"",saveUrl:"",state:!0,addressProvided:!1,submitButton:"",editButton:"",addressBlock:"",addressForm:""},_create:function(){this._super(),this.submitButton=$(this.options.submitButton),this.editButton=$(this.options.editButton),this.addressProvided=this.options.addressProvided;var e=this;this.element.find("#form-close-row").click(function(t){$("body").removeClass("no-scroll"),e.element.removeClass("form-shown")}),this.submitButton.click(function(t){!0===document.getElementById(e.element.find("form").attr("id")).checkValidity()&&(t.preventDefault(),t.stopPropagation(),e.save())}),this.editButton.click(function(t){t.preventDefault(),e.enable(),$(".payment-arrow").hide()}),$(document).ready(function(){e.addressProvided&&(e.getPayment().payment("enable"),e.getApplyCoupon().apply_coupon("enable"),e.scrollTo(e.getApplyCoupon().apply_coupon("getElement")),e.renderRoverPixel(e.options.doneRoverPixel))})},save:function(e){var t=this,s=this.element.find("form");t.getTotals().totals("setCheckbox",$("#marketing_consent").is(":checked"),$("#catch-marketing_consent").is(":checked")),t.startLoading(),$.ajax(this.options.saveUrl,{method:"POST",data:s.serialize(),success:function(e){if(e.error)return t.enable(),t.showError(e.error),t.scrollTo(t.element),void t.stopLoading();t.element.addClass("address-entered"),t.element.removeClass("form-shown"),$("body").removeClass("no-scroll"),t.disable(),t.getItemWrapper().item_wrapper("refresh"),t.getTotals().totals("refresh"),t.getPayment().payment("enable"),t.getApplyCoupon().apply_coupon("enable"),t.scrollTo(t.getPayment().payment("getElement")),t.scrollTo(t.getApplyCoupon().apply_coupon("getElement")),t.renderRoverPixel(t.options.doneRoverPixel)},error:function(e){t.showError(e.statusText),t.scrollTo(t.element),t.stopLoading()},complete:function(e){}})},enable:function(){this.removeError(),this.element.removeClass("address-entered"),this.element.find(this.options.addressBlock).hide(),this.element.find(this.options.addressForm).show(),this.getPayment().payment("disable"),this.getTotals().totals("disable"),this.setTotalsInfo(),this.getProgressWrapper().progress("updateProgressDelivery")},disable:function(){this.removeError();var e=this.element.find(this.options.addressForm),t=this.element.find(this.options.addressBlock);$(e).find("input, select, textarea").each(function(e){var s=$(this);"SELECT"==this.nodeName?t.find("span#"+s.attr("name")).html(s.find("option:selected").text()):"country"!==s.attr("name")&&t.find("span#"+s.attr("name")).html(s.val())}),e.hide(),t.show()}}),$.widget("iways.payment",$.iways.checkout,{options:{saveUrl:"",state:!1,getUrl:"",addressBlock:"",addressForm:"",editButton:""},_create:function(){this._super();var e=this;this.editButton=$(this.options.editButton),this.editButton.click(function(t){t.preventDefault(),e.showEditForm()}),window.paymentState=this.options.state,this.element.find("#form-close-row").click(function(t){e.element.removeClass("form-shown"),$("body").removeClass("no-scroll")}),this.element.find(".payment-method-title-row").each(function(){$(this).click(function(t){var s=t.target;if(e.element.hasClass("disabled")&&window.paymentState&&e.enable(),e.element.hasClass("enabled")){var n=$(s).closest(".payment-method-title-row").data("payment-method-type");e.element.find(".payment-method.payment-method-selected").removeClass("payment-method-selected"),e.element.find(".payment-method."+n).addClass("payment-method-selected")}})})},save:function(e,t){var s=this;s.startLoading();var n=new FormData(document.querySelector("#payment-method-"+e));n=objectToFormData(t,n,"additionalData"),$.ajax(this.options.saveUrl,{method:"POST",data:n,contentType:!1,processData:!1,success:function(t){if(s.stopLoading(),t.error)return window.paymentState=!1,void s.showError(t.error,e);s.element.removeClass("form-shown"),$("body").removeClass("no-scroll"),window.paymentState=!0,s.getTotals().totals("enable"),s.scrollTo(s.getTotals().totals("getElement")),s.disable(),s.getTotals().totals("setText",""),s.getPayment().addClass("payment-entered"),s.element.find(".payment-method-title-row").addClass("pointer").click(function(e){e.target;s.element.hasClass("disabled")&&window.paymentState&&s.enable()}),s.renderRoverPixel(s.options.doneRoverPixel),pandata.paymentOption=e,s.scrollTo(s.getTotals().totals("getElement"))},error:function(t){window.paymentState=!1,s.showError(t.statusText,e)}})},enable:function(){this.startLoading(),this.getTotals().totals("disable"),this.getProgressWrapper().progress("updateProgressPayment"),this.element.find(".payment-method-success-info").html(""),this.element.removeClass("disabled"),this.element.removeClass("payment-entered"),this.element.addClass("enabled"),window.paymentState=!1;var e=this.element.hasClass("form-shown"),t=this;t.setTotalsInfo(),window.paymentState||$.ajax(this.options.getUrl).done(function(s){t.element.parent().html(s),window.paymentState=!1,e?($("body").addClass("no-scroll"),t.getPayment().addClass("form-shown")):$("body").removeClass("no-scroll")})},disable:function(){this.removeError(),this.element.addClass("disabled"),this.element.removeClass("enabled"),this.element.removeClass("payment-entered"),this.element.find(".payment-method-body").html(""),this.element.find(".payment-method-title-row").removeClass("pointer").unbind("click"),this.element.find(".border-box").addClass("no-body")},showEditForm:function(){this.getTotals().totals("disable"),this.element.find(this.options.addressForm).show(),this.element.find(this.options.addressBlock).hide()},getState:function(){return window.paymentState},showError:function(e,t){if(this.removeError(),void 0!==t)var s=this.element.find("."+t+" "+this.options.errorContainer);else s=this.element.find(this.options.errorContainer);"string"==$.type(e)?s.show().html($('<div class="row"><div class="col error-message">'+e+"</div></div>")):(s.show(),$.each(e,function(e,t){s.append($('<div class="row"><div class="col error-message">'+t+"</div></div>"))})),push2dataLayer({event:"paymentError",paymentMethod:t,errorMessage:e})}}),$.widget("iways.totals",$.iways.checkout,{options:{getUrl:"",submitButton:"",submitUrl:"",successUrl:"",stepInfoElement:".step-info",ebayCheck:!1,catchCheck:!1,paymentStepCallback:function(){}},_create:function(){this._super(),this.submitButton=$(this.options.submitButton),this.stepInfoElement=$(this.options.stepInfoElement),void 0!==window.statusInfo&&this.setText(window.statusInfo),window.paymentState&&this.enable();var e=this;this.element.find(".legal-messages input[required]").click(function(t){e.enable()}),this.submitButton.click(function(){e.submit()}),this.stopLoading()},enable:function(){this.getProgressWrapper().progress("updateProgressTotals");var e=!0;$.each(this.element.find(".legal-messages input[required]"),function(t,s){$(s).prop("checked")||(e=!1)}),!0===e?window.paymentState&&(this.element.find(this.options.submitButton).removeAttr("disabled"),this.element.find(".button-wrapper").removeClass("disabled"),this.options.paymentStepCallback()):this.disable()},disable:function(){this.element.find(this.options.submitButton).attr("disabled","disabled"),this.element.find(".button-wrapper").addClass("disabled")},refresh:function(){var e=this;window.statusInfo=e.element.find(e.options.stepInfoElement).html(),e.startLoading(),$.ajax(this.options.getUrl).done(function(t){e.element.parent().html(t),window.paymentState&&e.enable(),e.options.ebayCheck&&$("#marketing_consent").attr("checked","checked"),e.options.catchCheck&&$("#catch-marketing_consent").attr("checked","checked")})},setText:function(e){window.statusInfo=e,this.stepInfoElement.html(e)},setCheckbox:function(e,t){this.options.ebayCheck=e,this.options.catchCheck=t},submit:function(){var e=this;e.startLoading();var t=new FormData;t.append("success",this.options.successUrl),$.each(this.element.find(".legal-messages input[required]"),function(e,s){t.append("legalMessage["+$(s).attr("name")+"]",$(s).prop("checked"))}),t.append("marketingConsent",$("#marketing_consent").prop("checked")),t.append("catchMarketingConsent",$("#catch-marketing_consent").prop("checked")),$.ajax(this.options.submitUrl,{method:"POST",data:t,contentType:!1,processData:!1,success:function(t){if(t.error)return $("body").children("div.loader").remove(),void e.showError(t.error);t.redirectUrl==e.options.successUrl?($("#marketing_consent").prop("checked")&&push2dataLayer({event:"newsletter",newsletterAction:"Requested",newsletterLabel:"checkout"}),window.location.href=t.redirectUrl):location.reload()},error:function(t){e.showError(t.statusText),e.stopLoading()}})}}),$.widget("iways.progress",$.iways.checkout,{_create:function(){this._super()},updateProgressDelivery:function(){this.updateWidget(1)},updateProgressPayment:function(){this.updateWidget(2)},updateProgressTotals:function(){this.updateWidget(3)},updateWidget:function(e){var t=this.element;1===e?(t.find(".second-part").removeClass("done").addClass("active"),t.find(".third-part").removeClass("done active").addClass("outstanding"),t.find(".fourth-part").removeClass("active").addClass("outstanding"),t.find(".first-message").show(),t.find(".second-message, .third-message").hide(),t.find(".second.connector, .third.connector").removeClass("active")):2===e?(t.find(".second-part").removeClass("active").addClass("done"),t.find(".third-part").removeClass("outstanding done").addClass("active"),t.find(".fourth-part").removeClass("active").addClass("outstanding"),t.find(".second-message").show(),t.find(".first-message, .third-message").hide(),t.find(".second.connector").addClass("active"),t.find(".third.connector").removeClass("active")):3===e&&(t.find(".third-part").removeClass("active outstanding").addClass("done"),t.find(".fourth-part").removeClass("outstanding").addClass("active"),t.find(".first-message, .second-message").hide(),t.find(".third-message").show(),t.find(".third.connector").addClass("active"))}}),$.widget("iways.apply_coupon",$.iways.checkout,{options:{saveUrl:"",getUrl:"",submitButton:""},_create:function(){this._super(),this.submitButton=$(this.options.submitButton);var e=this;this.submitButton.click(function(t){!0===document.getElementById(e.element.find("form").attr("id")).checkValidity()&&(t.preventDefault(),t.stopPropagation(),e.save())})},save:function(e){var t=this,s=this.element.find("form");t.startLoading(),t.getPayment().payment("startLoading"),$.ajax(this.options.saveUrl,{method:"POST",data:s.serialize(),success:function(e){e.error?t.showError(e.error):(t.removeError(),t.element.find("input[type=text]").val()?(t.submitButton.addClass("success"),t.element.find("input[type=text]").data("code",t.element.find("input[type=text]").val()),t.submitButton.html(t.submitButton.data("success-text")),t.scrollTo(t.getPayment("getElement"))):(t.submitButton.removeClass("success"),t.element.find("input[type=text]").data("code",t.element.find("input[type=text]").val()),t.submitButton.html(t.submitButton.data("submit-text"))))},error:function(e){t.showError(e.statusText)},complete:function(e){t.stopLoading(),t.getPayment().payment("enable"),t.getTotals().totals("refresh")}})},enable:function(){this.element.find("#apply-coupon-disabled").hide(),this.element.find("#apply-coupon-form-row").show(),this.element.find("input[type=text]").data("code")?(this.submitButton.addClass("success"),this.submitButton.html(this.submitButton.data("success-text"))):(this.submitButton.removeClass("success"),this.submitButton.html(this.submitButton.data("submit-text"))),this.removeError()},disable:function(){this.element.find("#apply-coupon-disabled").show(),this.element.find("#apply-coupon-form-row").hide(),this.removeError()}});